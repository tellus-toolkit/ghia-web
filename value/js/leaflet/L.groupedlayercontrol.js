/* global L */

// A layer control which provides for layer groupings.
// Author: Ishmael Smyrnow
L.Control.GroupedLayers=L.Control.extend({options:{collapsed:!0,position:"topright",autoZIndex:!0,exclusiveGroups:[],groupCheckboxes:!1},initialize:function(e,t,a){var i,r;L.Util.setOptions(this,a),this._layers={},this._lastZIndex=0,this._handlingClick=!1,this._groupList=[],this._domGroups=[];for(i in e)this._addLayer(e[i],i);for(i in t)for(var r in t[i])this._addLayer(t[i][r],r,i,!0)},onAdd:function(e){return this._initLayout(),this._update(),e.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},onRemove:function(e){e.off("layeradd",this._onLayerChange).off("layerremove",this._onLayerChange)},addBaseLayer:function(e,t){return this._addLayer(e,t),this._update(),this},addOverlay:function(e,t,a){return this._addLayer(e,t,a,!0),this._update(),this},removeLayer:function(e){var t=L.Util.stamp(e);return delete this._layers[t],this._update(),this},_initLayout:function(){var e="leaflet-control-layers",t=this._container=L.DomUtil.create("div",e);t.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(t,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"wheel",L.DomEvent.stopPropagation));var a=this._form=L.DomUtil.create("form",e+"-list");if(this.options.collapsed){L.Browser.android||L.DomEvent.on(t,"mouseover",this._expand,this).on(t,"mouseout",this._collapse,this);var i=this._layersLink=L.DomUtil.create("a",e+"-toggle",t);i.href="#",i.title="Layers",L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stop).on(i,"click",this._expand,this):L.DomEvent.on(i,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();this._baseLayersList=L.DomUtil.create("div",e+"-base",a),this._separator=L.DomUtil.create("div",e+"-separator",a),this._overlaysList=L.DomUtil.create("div",e+"-overlays",a),t.appendChild(a)},_addLayer:function(e,t,a,i){var r=L.Util.stamp(e);this._layers[r]={layer:e,name:t,overlay:i},a=a||"";var s=this._indexOf(this._groupList,a);-1===s&&(s=this._groupList.push(a)-1);var o=-1!=this._indexOf(this.options.exclusiveGroups,a);this._layers[r].group={name:a,id:s,exclusive:o},this.options.autoZIndex&&e.setZIndex&&(this._lastZIndex++,e.setZIndex(this._lastZIndex))},_update:function(){if(this._container){this._baseLayersList.innerHTML="",this._overlaysList.innerHTML="",this._domGroups.length=0;var e,t,a=!1,i=!1;for(e in this._layers)t=this._layers[e],this._addItem(t),i=i||t.overlay,a=a||!t.overlay;this._separator.style.display=i&&a?"":"none"}},_onLayerChange:function(e){var t=this._layers[L.Util.stamp(e.layer)];if(t){this._handlingClick||this._update();var a=t.overlay?"layeradd"===e.type?"overlayadd":"overlayremove":"layeradd"===e.type?"baselayerchange":null;a&&this._map.fire(a,t)}},_createRadioElement:function(e,t){var a='<input type="radio" class="leaflet-control-layers-selector" name="'+e+'"';t&&(a+=' checked="checked"'),a+="/>";var i=document.createElement("div");return i.innerHTML=a,i.firstChild},_addItem:function(e){var t,a,i=document.createElement("label"),r=this._map.hasLayer(e.layer);e.overlay?e.group.exclusive?(groupRadioName="leaflet-exclusive-group-layer-"+e.group.id,t=this._createRadioElement(groupRadioName,r)):(t=document.createElement("input"),t.type="checkbox",t.className="leaflet-control-layers-selector",t.defaultChecked=r):t=this._createRadioElement("leaflet-base-layers",r),t.layerId=L.Util.stamp(e.layer),t.groupID=e.group.id,L.DomEvent.on(t,"click",this._onInputClick,this);var s=document.createElement("span");if(s.innerHTML=" "+e.name,i.appendChild(t),i.appendChild(s),e.overlay){a=this._overlaysList;var o=this._domGroups[e.group.id];if(!o){o=document.createElement("div"),o.className="leaflet-control-layers-group",o.id="leaflet-control-layers-group-"+e.group.id;var n=document.createElement("label");if(n.className="leaflet-control-layers-group-label",""!=e.group.name&&!e.group.exclusive&&this.options.groupCheckboxes){var l=document.createElement("input");l.type="checkbox",l.className="leaflet-control-layers-group-selector",l.groupID=e.group.id,l.legend=this,L.DomEvent.on(l,"click",this._onGroupInputClick,l),n.appendChild(l)}var h=document.createElement("span");h.className="leaflet-control-layers-group-name",h.innerHTML=e.group.name,n.appendChild(h),o.appendChild(n),a.appendChild(o),this._domGroups[e.group.id]=o}a=o}else a=this._baseLayersList;return a.appendChild(i),i},_onGroupInputClick:function(){var e,t,a;this_legend=this.legend,this_legend._handlingClick=!0;var i=this_legend._form.getElementsByTagName("input"),r=i.length;for(e=0;r>e;e++)t=i[e],t.groupID==this.groupID&&"leaflet-control-layers-selector"==t.className&&(t.checked=this.checked,a=this_legend._layers[t.layerId],t.checked&&!this_legend._map.hasLayer(a.layer)?this_legend._map.addLayer(a.layer):!t.checked&&this_legend._map.hasLayer(a.layer)&&this_legend._map.removeLayer(a.layer));this_legend._handlingClick=!1},_onInputClick:function(){var e,t,a,i=this._form.getElementsByTagName("input"),r=i.length;for(this._handlingClick=!0,e=0;r>e;e++)t=i[e],"leaflet-control-layers-selector"==t.className&&(a=this._layers[t.layerId],t.checked&&!this._map.hasLayer(a.layer)?this._map.addLayer(a.layer):!t.checked&&this._map.hasLayer(a.layer)&&this._map.removeLayer(a.layer));this._handlingClick=!1},_expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-layers-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-layers-expanded","")},_indexOf:function(e,t){for(var a=0,i=e.length;i>a;a++)if(e[a]===t)return a;return-1}}),L.control.groupedLayers=function(e,t,a){return new L.Control.GroupedLayers(e,t,a)};